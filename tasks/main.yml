# roles/acme_issue/tasks/main.yml

- name: Ensure ca-certificates package present
  ansible.builtin.apt:
    name: ca-certificates
    state: present
    update_cache: true

- name: Fetch step-ca roots bundle
  ansible.builtin.get_url:
    url: "https://{{ acme_issue_step_ca_host }}:{{ acme_issue_step_ca_port }}/roots.pem"
    dest: "/usr/local/share/ca-certificates/step-root.crt"
    mode: "0644"
    validate_certs: false

- name: Update CA trust now
  ansible.builtin.command: update-ca-certificates
  changed_when: false

- name: Ensure ACME challenge path exists
  ansible.builtin.file:
    path: "{{ acme_issue_cert_webroot }}/.well-known/acme-challenge"
    state: directory
    owner: "{{ acme_issue_cert_owner }}"
    group: "{{ acme_issue_cert_group }}"
    mode: "0755"

- name: Define certificate file paths
  ansible.builtin.set_fact:
    acme_issue_key_path: "{{ acme_issue_cert_install_dir }}/{{ acme_issue_cert_service_name }}.key"
    acme_issue_csr_path: "{{ acme_issue_cert_install_dir }}/{{ acme_issue_cert_service_name }}.csr"
    acme_issue_cert_path: "{{ acme_issue_cert_install_dir }}/{{ acme_issue_cert_service_name }}.crt"
    acme_issue_chain_path: "{{ acme_issue_cert_install_dir }}/{{ acme_issue_cert_service_name }}-chain.crt"
    acme_issue_fullchain_path: "{{ acme_issue_cert_install_dir }}/{{ acme_issue_cert_service_name }}-fullchain.crt"

- name: Check if certificate exists
  ansible.builtin.stat:
    path: "{{ acme_issue_cert_path }}"
  register: acme_issue_existing_cert

- name: Get certificate expiry information
  community.crypto.x509_certificate_info:
    path: "{{ acme_issue_cert_path }}"
  register: acme_issue_cert_info
  when: acme_issue_existing_cert.stat.exists

- name: Calculate days until expiry
  ansible.builtin.set_fact:
    acme_issue_days_remaining: >-
      {{ ((acme_issue_cert_info.not_after | to_datetime('%Y%m%d%H%M%SZ'))
          - (ansible_date_time.date | to_datetime('%Y-%m-%d'))).days }}
  when: acme_issue_existing_cert.stat.exists

- name: Determine if renewal is needed
  ansible.builtin.set_fact:
    acme_issue_needs_renewal: >-
      {{
        acme_issue_force_renewal | bool or
        not acme_issue_existing_cert.stat.exists or
        (acme_issue_days_remaining | int) <= (acme_issue_renewal_threshold_days | int)
      }}

- name: Display certificate status
  ansible.builtin.debug:
    msg: >
      Certificate status:
      {% if not acme_issue_existing_cert.stat.exists %}Not found - will issue new certificate
      {% elif acme_issue_force_renewal | bool %}Force renewal enabled
      {% else %}{{ acme_issue_days_remaining }} days remaining -
      {% if acme_issue_needs_renewal %}renewal needed (threshold: {{ acme_issue_renewal_threshold_days }} days)
      {% else %}no renewal needed{% endif %}{% endif %}

- name: Generate service private key (ECDSA P-256)
  community.crypto.openssl_privatekey:
    path: "{{ acme_issue_key_path }}"
    type: ECC
    curve: secp256r1
    owner: "{{ acme_issue_cert_owner }}"
    group: "{{ acme_issue_cert_group }}"
    mode: "0640"
    force: false

- name: Generate CSR for the service (ECDSA)
  community.crypto.openssl_csr:
    path: "{{ acme_issue_csr_path }}"
    privatekey_path: "{{ acme_issue_key_path }}"
    common_name: "{{ acme_issue_cert_common_name }}"
    subject_alt_name: "{{ acme_issue_cert_sans | map('regex_replace', '^(.*)$', 'DNS:\\1') | list }}"
    force: true
  when: acme_issue_needs_renewal | bool

- name: Ensure ACME account is registered
  community.crypto.acme_account:
    acme_directory: "{{ acme_issue_directory_url }}"
    account_key_src: "{{ acme_issue_account_key_path }}"
    state: present
  register: acme_issue_acct
  when: acme_issue_needs_renewal | bool

- name: Create certificate order
  community.crypto.acme_certificate_order_create:
    acme_directory: "{{ acme_issue_directory_url }}"
    account_key_src: "{{ acme_issue_account_key_path }}"
    account_uri: "{{ acme_issue_acct.account_uri }}"
    csr: "{{ acme_issue_csr_path }}"
  register: acme_issue_order
  when: acme_issue_needs_renewal | bool

- name: Filter http-01 challenge items
  ansible.builtin.set_fact:
    acme_issue_http01_items: "{{ acme_issue_order.challenge_data | selectattr('challenges.http-01', 'defined') | list }}"
  when: acme_issue_needs_renewal | bool and not ansible_check_mode

- name: Publish ACME http-01 tokens
  ansible.builtin.copy:
    dest: "{{ acme_issue_cert_webroot }}/{{ item.challenges['http-01']['resource'] }}"
    content: "{{ item.challenges['http-01']['resource_value'] }}"
    owner: "{{ acme_issue_cert_owner }}"
    group: "{{ acme_issue_cert_group }}"
    mode: "0644"
  loop: "{{ acme_issue_http01_items }}"
  when: acme_issue_needs_renewal | bool and not ansible_check_mode

- name: Validate http-01 challenges
  community.crypto.acme_certificate_order_validate:
    acme_directory: "{{ acme_issue_directory_url }}"
    account_key_src: "{{ acme_issue_account_key_path }}"
    account_uri: "{{ acme_issue_acct.account_uri }}"
    challenge: http-01
    order_uri: "{{ acme_issue_order.order_uri }}"
  when: acme_issue_needs_renewal | bool and not ansible_check_mode

- name: Finalize order and retrieve certificate
  community.crypto.acme_certificate_order_finalize:
    acme_directory: "{{ acme_issue_directory_url }}"
    account_key_src: "{{ acme_issue_account_key_path }}"
    account_uri: "{{ acme_issue_acct.account_uri }}"
    order_uri: "{{ acme_issue_order.order_uri }}"
    csr: "{{ acme_issue_csr_path }}"
    cert_dest: "{{ acme_issue_cert_path }}"
    chain_dest: "{{ acme_issue_chain_path }}"
  register: acme_issue_finalize_result
  when: acme_issue_needs_renewal | bool and not ansible_check_mode

- name: Read server certificate
  ansible.builtin.slurp:
    src: "{{ acme_issue_cert_path }}"
  register: acme_issue_slurped_server_cert
  when: acme_issue_needs_renewal | bool and acme_issue_finalize_result.changed and not ansible_check_mode

- name: Read chain certificate
  ansible.builtin.slurp:
    src: "{{ acme_issue_chain_path }}"
  register: acme_issue_slurped_chain_cert
  when: acme_issue_needs_renewal | bool and acme_issue_finalize_result.changed and not ansible_check_mode

- name: Create fullchain certificate (server + chain)
  ansible.builtin.copy:
    content: "{{ acme_issue_slurped_server_cert.content | b64decode }}{{ acme_issue_slurped_chain_cert.content | b64decode }}"
    dest: "{{ acme_issue_fullchain_path }}"
    owner: "{{ acme_issue_cert_owner }}"
    group: "{{ acme_issue_cert_group }}"
    mode: "0644"
  when: acme_issue_needs_renewal | bool and acme_issue_finalize_result.changed and not ansible_check_mode

- name: Set ownership on new certificate files
  ansible.builtin.file:
    path: "{{ item }}"
    owner: "{{ acme_issue_cert_owner }}"
    group: "{{ acme_issue_cert_group }}"
    mode: "0644"
  loop:
    - "{{ acme_issue_cert_path }}"
    - "{{ acme_issue_chain_path }}"
  when: acme_issue_needs_renewal | bool and acme_issue_finalize_result.changed and not ansible_check_mode

- name: Set fact for service reload
  ansible.builtin.set_fact:
    acme_issue_cert_changed: true
  when: acme_issue_needs_renewal | bool and acme_issue_finalize_result.changed and not ansible_check_mode
